<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ËØ≠ÂçïËØçÁªÉ‰π†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
            color: #333;
        }

        /* Navigation Bar */
        .navbar {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .navbar-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .navbar-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .lang-switch {
            padding: 0.4rem 0.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .lang-switch:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .progress-badge {
            background: #e8f4fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .mode-switch {
            display: flex;
            background: #f0f0f0;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #666;
        }

        .mode-btn.active {
            background: white;
            color: #1976d2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Main Practice Area */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .practice-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }

        .chinese-word {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .word-hint {
            font-size: 0.875rem;
            color: #888;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .input-container {
            margin-bottom: 1rem;
        }

        .english-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            text-align: center;
            transition: border-color 0.2s;
        }

        .english-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .english-input.correct {
            border-color: #4caf50;
            background-color: #f1f8e9;
        }

        .english-input.incorrect {
            border-color: #f44336;
            background-color: #ffebee;
        }

        /* Part of Speech Selection */
        .pos-selection {
            margin-bottom: 1.5rem;
        }

        .pos-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .pos-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .pos-btn {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: 2px solid #e0e0e0;
            background: #fafafa;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .pos-btn:hover {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .pos-btn.selected {
            border-color: #1976d2;
            background: #1976d2;
            color: white;
        }

        .pos-btn.correct {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .pos-btn.incorrect {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .pos-btn.show-correct {
            border-color: #4caf50;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .pos-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Check Button */
        .check-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .check-btn:hover {
            background: #1565c0;
        }

        .check-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }

        /* Feedback Area */
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
        }

        .feedback.partial {
            background: #fff3e0;
            color: #e65100;
        }

        .correct-answer {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .answer-details {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            text-align: left;
            padding: 0.5rem;
            background: rgba(255,255,255,0.5);
            border-radius: 0.25rem;
        }

        .answer-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .answer-detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            font-weight: 600;
        }

        .detail-value.correct-val {
            color: #2e7d32;
        }

        .detail-value.incorrect-val {
            color: #c62828;
        }

        /* Control Area */
        .control-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .control-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .control-select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            background: white;
            cursor: pointer;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .next-btn {
            background: #4caf50;
            color: white;
        }

        .next-btn:hover {
            background: #43a047;
        }

        .next-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }

        .restart-btn {
            background: #ff9800;
            color: white;
        }

        .restart-btn:hover {
            background: #f57c00;
        }

        /* Top Stats Bar */
        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.75rem 1rem;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .stat-item-top {
            text-align: center;
            padding: 0.4rem 0.8rem;
            background: rgba(255,255,255,0.15);
            border-radius: 0.5rem;
            transition: transform 0.3s, background 0.3s;
            min-width: 60px;
        }

        .stat-item-top .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .stat-item-top .stat-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.85);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-item-top.correct-stat .stat-value {
            color: #a5d6a7;
        }

        .stat-item-top.wrong-stat .stat-value {
            color: #ef9a9a;
        }

        .stat-item-top.rate-stat .stat-value {
            color: #90caf9;
        }

        .stat-item-top.streak-stat {
            background: rgba(255,215,0,0.25);
            border: 1px solid rgba(255,215,0,0.5);
        }

        .stat-item-top.streak-stat .stat-value {
            color: #ffd700;
        }

        /* Bounce animation for correct answers */
        @keyframes bounce-correct {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.3); }
            60% { transform: scale(0.95); }
        }

        .stat-item-top.animate-correct {
            animation: bounce-correct 0.5s ease;
            background: rgba(76, 175, 80, 0.4);
        }

        /* Shake animation for wrong answers */
        @keyframes shake-wrong {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .stat-item-top.animate-wrong {
            animation: shake-wrong 0.4s ease;
            background: rgba(244, 67, 54, 0.4);
        }

        /* Streak glow animation */
        @keyframes streak-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,215,0,0.8), 0 0 25px rgba(255,165,0,0.5); }
        }

        .stat-item-top.streak-stat.active {
            animation: streak-glow 1.5s ease infinite;
        }

        /* Encouragement message */
        .encouragement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2.5rem;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .encouragement.show {
            opacity: 1;
            animation: pop-in 0.5s ease;
        }

        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .encouragement.perfect {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        }

        /* Old stats in control card - hidden */
        .stats {
            display: none;
        }

        /* Results Screen */
        .results-screen {
            display: none;
        }

        .results-screen.show {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            color: #1976d2;
        }

        .results-percentage {
            font-size: 1.25rem;
            color: #666;
        }

        .wrong-words-section {
            margin-top: 1.5rem;
        }

        .wrong-words-title {
            font-size: 1rem;
            color: #c62828;
            margin-bottom: 0.75rem;
        }

        .wrong-word-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: #fff8f8;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #f44336;
        }

        .wrong-english {
            font-weight: 600;
            color: #c62828;
        }

        .wrong-chinese {
            color: #666;
        }

        .wrong-pos {
            color: #888;
            font-size: 0.875rem;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .redo-wrong-btn {
            flex: 1;
            padding: 0.75rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .redo-wrong-btn:hover {
            background: #d32f2f;
        }

        /* Retry Button */
        .retry-btn {
            margin-top: 0.75rem;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-btn:hover {
            background: #f57c00;
        }

        /* Unit Stats (Random Mode) */
        .unit-stats {
            margin-top: 1.5rem;
        }

        .unit-stats-title {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 0.75rem;
        }

        .unit-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .unit-stat-name {
            color: #666;
        }

        .unit-stat-bar {
            flex: 1;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .unit-stat-fill {
            height: 100%;
            background: #4caf50;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .unit-stat-value {
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        /* Storage Actions */
        .storage-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .clear-storage-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            cursor: pointer;
            color: #666;
        }

        .clear-storage-btn:hover {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 2rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .welcome-text {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .start-btn {
            padding: 1rem 2rem;
            font-size: 1.125rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .start-btn:hover {
            background: #1565c0;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .navbar-content {
                padding: 0 0.5rem;
            }

            .app-title {
                font-size: 1.25rem;
            }

            .practice-card {
                padding: 1.5rem 1rem;
            }

            .chinese-word {
                font-size: 1.75rem;
            }

            .english-input {
                font-size: 1.125rem;
            }

            .pos-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.875rem;
            }

            .control-row {
                flex-direction: column;
            }

            .results-actions {
                flex-direction: column;
            }

            .stats-bar {
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .stat-item-top {
                padding: 0.3rem 0.5rem;
                min-width: 50px;
            }

            .stat-item-top .stat-value {
                font-size: 1rem;
            }

            .stat-item-top .stat-label {
                font-size: 0.6rem;
            }

            .encouragement {
                font-size: 1.25rem;
                padding: 1rem 1.5rem;
            }
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* ==================== ‰æßËæπÊ†èÁªüËÆ°Èù¢Êùø ==================== */

        /* ‰æßËæπÊ†èÂÆπÂô® */
        .stats-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 280px;
            background: white;
            box-shadow: -2px 0 15px rgba(0,0,0,0.1);
            z-index: 200;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        .stats-sidebar.collapsed {
            transform: translateX(280px);
        }

        /* ÂàáÊç¢ÊåâÈíÆ */
        .sidebar-toggle {
            display: none;
            position: fixed;
            right: 280px;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem 0 0 0.5rem;
            cursor: pointer;
            z-index: 201;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
        }

        .sidebar-toggle .toggle-icon {
            font-size: 1.25rem;
        }

        .sidebar-toggle .toggle-text {
            writing-mode: vertical-rl;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* ‰æßËæπÊ†èÂÜÖÂÆπ */
        .sidebar-content {
            height: 100%;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .sidebar-close {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .sidebar-close:hover {
            color: #333;
        }

        /* ÁªüËÆ°Âå∫Âùó */
        .stats-section {
            background: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #666;
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ÁªüËÆ°Ë°å */
        .stat-row {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-row.highlight {
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin: 0.5rem -0.5rem;
            border-bottom: none;
        }

        .stat-icon {
            width: 24px;
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        .stat-name {
            flex: 1;
            font-size: 0.875rem;
            color: #555;
        }

        .stat-number {
            font-size: 1.125rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-row.highlight .stat-number {
            color: #764ba2;
        }

        /* ÊéåÊè°ËøõÂ∫¶Êù° */
        .mastery-progress {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.75rem;
            color: #888;
        }

        /* ‰ªäÊó•ÁªüËÆ°Âå∫Âùó */
        .today-section {
            background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
            border: 1px solid rgba(102,126,234,0.2);
        }

        /* Â≠¶‰π†ÊèêÁ§∫ */
        .stats-tip {
            text-align: center;
            padding: 1rem;
            background: #fff8e1;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #f57c00;
            border: 1px dashed #ffc107;
        }

        /* ÈÅÆÁΩ©Â±Ç */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 199;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* ==================== ‰æßËæπÊ†èÂìçÂ∫îÂºèÂ∏ÉÂ±Ä ==================== */

        /* Ê°åÈù¢Á´Ø - ‰æßËæπÊ†èÂ∏∏È©ª */
        @media (min-width: 1200px) {
            body {
                padding-right: 280px;
            }

            .navbar {
                margin-right: 280px;
            }

            .stats-bar {
                margin-right: 280px;
            }

            .encouragement {
                margin-right: 140px;
            }
        }

        /* Âπ≥ÊùøÁ´Ø - ‰æßËæπÊ†èÂèØÊäòÂè† */
        @media (max-width: 1199px) and (min-width: 769px) {
            .stats-sidebar {
                width: 260px;
            }

            .stats-sidebar.collapsed {
                transform: translateX(260px);
            }

            .sidebar-toggle {
                display: flex;
                right: 0;
            }

            .stats-sidebar:not(.collapsed) .sidebar-toggle {
                right: 260px;
            }

            .stats-sidebar.collapsed .sidebar-toggle {
                right: 0;
            }
        }

        /* ÁßªÂä®Á´Ø - Â∫ïÈÉ®ÊäΩÂ±âÂºè */
        @media (max-width: 768px) {
            .stats-sidebar {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: auto;
                max-height: 70vh;
                transform: translateY(100%);
                border-radius: 1rem 1rem 0 0;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            }

            .stats-sidebar.expanded {
                transform: translateY(0);
            }

            .sidebar-toggle {
                display: flex;
                position: fixed;
                bottom: 0;
                right: auto;
                left: 50%;
                top: auto;
                transform: translateX(-50%);
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem 1.5rem;
                border-radius: 1rem 1rem 0 0;
            }

            .stats-sidebar.expanded .sidebar-toggle {
                display: none;
            }

            .sidebar-toggle .toggle-text {
                writing-mode: horizontal-tb;
                margin-top: 0;
            }

            .sidebar-close {
                display: block;
            }

            .sidebar-content {
                padding: 1rem;
            }

            .stats-section {
                padding: 0.75rem;
            }

            .stats-tip {
                padding: 0.75rem;
            }
        }

        /* iPad Portrait (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .navbar-content,
            .main-container {
                max-width: 680px;
            }

            .app-title {
                font-size: 1.75rem;
            }

            .mode-btn {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }

            .practice-card {
                padding: 2.5rem;
            }

            .chinese-word {
                font-size: 2.5rem;
            }

            .word-hint {
                font-size: 1rem;
            }

            .english-input {
                padding: 1.25rem;
                font-size: 1.5rem;
            }

            .pos-btn {
                padding: 0.6rem 1rem;
                font-size: 1.125rem;
            }

            .check-btn {
                padding: 1.25rem;
                font-size: 1.25rem;
            }

            .action-btn {
                padding: 1rem 1.25rem;
                font-size: 1.125rem;
            }

            .control-select {
                padding: 1rem;
                font-size: 1.125rem;
            }

            .stats-bar {
                padding: 1rem 1.5rem;
                gap: 1.25rem;
            }

            .stat-item-top {
                padding: 0.5rem 1rem;
                min-width: 70px;
            }

            .stat-item-top .stat-value {
                font-size: 1.5rem;
            }

            .stat-item-top .stat-label {
                font-size: 0.8rem;
            }

            .feedback {
                padding: 1.25rem;
                font-size: 1.1rem;
            }

            .correct-answer {
                font-size: 1.5rem;
            }
        }

        /* iPad Landscape & Larger iPads (1024px+) */
        @media (min-width: 1024px) {
            .navbar-content,
            .main-container {
                max-width: 900px;
            }

            .app-title {
                font-size: 1.875rem;
            }

            .mode-btn {
                padding: 0.85rem 1.5rem;
                font-size: 1.0625rem;
            }

            .practice-card {
                padding: 3rem;
            }

            .chinese-word {
                font-size: 2.75rem;
            }

            .word-hint {
                font-size: 1.0625rem;
            }

            .english-input {
                padding: 1.5rem;
                font-size: 1.625rem;
            }

            .pos-btn {
                padding: 0.75rem 1.25rem;
                font-size: 1.25rem;
            }

            .check-btn {
                padding: 1.5rem;
                font-size: 1.375rem;
            }

            .action-btn {
                padding: 1.125rem 1.5rem;
                font-size: 1.1875rem;
            }

            .control-select {
                padding: 1.125rem;
                font-size: 1.1875rem;
            }

            .stats-bar {
                padding: 1rem 2rem;
                gap: 1.5rem;
            }

            .stat-item-top {
                padding: 0.6rem 1.25rem;
                min-width: 80px;
            }

            .stat-item-top .stat-value {
                font-size: 1.75rem;
            }

            .stat-item-top .stat-label {
                font-size: 0.85rem;
            }

            .feedback {
                padding: 1.5rem;
                font-size: 1.125rem;
            }

            .correct-answer {
                font-size: 1.625rem;
            }

            .control-row {
                gap: 1.5rem;
            }
        }

        /* iPad Landscape Compact - avoid scrolling */
        @media (min-width: 768px) and (max-height: 850px) and (orientation: landscape) {
            .navbar {
                padding: 0.5rem 1rem;
            }

            .navbar-content {
                gap: 0.5rem;
            }

            .app-title {
                font-size: 1.25rem;
            }

            .mode-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.875rem;
            }

            .stats-bar {
                padding: 0.4rem 1rem;
            }

            .stat-item-top {
                padding: 0.25rem 0.5rem;
                min-width: 50px;
            }

            .stat-item-top .stat-value {
                font-size: 1.125rem;
            }

            .stat-item-top .stat-label {
                font-size: 0.65rem;
            }

            .main-container {
                padding: 0.75rem 1rem;
            }

            .practice-card {
                padding: 1rem 1.5rem;
                margin-bottom: 0.5rem;
                border-radius: 0.75rem;
            }

            .chinese-word {
                font-size: 1.75rem;
                margin-bottom: 0.25rem;
            }

            .word-hint {
                font-size: 0.8rem;
                margin-bottom: 0.75rem;
            }

            .english-input {
                padding: 0.75rem;
                font-size: 1.25rem;
            }

            .pos-selection {
                margin-bottom: 0.75rem;
            }

            .pos-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.875rem;
            }

            .check-btn {
                padding: 0.75rem;
                font-size: 1.125rem;
            }

            .feedback {
                margin-top: 0.5rem;
                padding: 0.5rem 0.75rem;
            }

            .correct-answer {
                font-size: 1.125rem;
                margin-top: 0.25rem;
            }

            .retry-btn {
                margin-top: 0.5rem;
                padding: 0.4rem 1rem;
                font-size: 0.9rem;
            }

            .control-card {
                padding: 0.75rem 1rem;
                border-radius: 0.75rem;
            }

            .control-row {
                margin-bottom: 0.5rem;
            }

            .control-label {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .control-select {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .action-btn {
                padding: 0.6rem 1rem;
                font-size: 1rem;
            }

            .storage-section {
                margin-top: 0.5rem;
                padding-top: 0.5rem;
            }

            .clear-storage-btn {
                padding: 0.35rem 0.75rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-top">
                <h1 class="app-title">Ëã±ËØ≠ÂçïËØçÁªÉ‰π†</h1>
                <a href="index.html" class="lang-switch">ÂàáÊç¢Âæ∑ËØ≠</a>
                <span class="progress-badge" id="progressBadge">0/0</span>
            </div>
            <div class="mode-switch">
                <button class="mode-btn active" data-mode="unit" onclick="switchMode('unit')">ÊåâÂçïÂÖÉÁªÉ‰π†</button>
                <button class="mode-btn" data-mode="random" onclick="switchMode('random')">ÈöèÊú∫ÊµãËØï</button>
            </div>
        </div>
    </nav>

    <!-- Top Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-item-top correct-stat" id="correctStat">
            <div class="stat-value" id="correctCountTop">0</div>
            <div class="stat-label">Ê≠£Á°Æ</div>
        </div>
        <div class="stat-item-top wrong-stat" id="wrongStat">
            <div class="stat-value" id="wrongCountTop">0</div>
            <div class="stat-label">ÈîôËØØ</div>
        </div>
        <div class="stat-item-top rate-stat" id="rateStat">
            <div class="stat-value" id="rateValue">0%</div>
            <div class="stat-label">Ê≠£Á°ÆÁéá</div>
        </div>
        <div class="stat-item-top streak-stat" id="streakStat">
            <div class="stat-value" id="streakValue">0</div>
            <div class="stat-label">ËøûÂØπ</div>
        </div>
    </div>

    <!-- Encouragement Message -->
    <div class="encouragement" id="encouragement"></div>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Welcome Screen -->
        <div class="practice-card welcome-screen" id="welcomeScreen">
            <h2 class="welcome-title">Ê¨¢Ëøé‰ΩøÁî®Ëã±ËØ≠ÂçïËØçÁªÉ‰π†</h2>
            <p class="welcome-text">ÈÄâÊã©ÂçïÂÖÉÊàñÈöèÊú∫ÊµãËØïÂºÄÂßãÁªÉ‰π†</p>
            <button class="start-btn" onclick="startPractice()">ÂºÄÂßãÁªÉ‰π†</button>
        </div>

        <!-- Practice Card -->
        <div class="practice-card hidden" id="practiceCard">
            <div class="chinese-word" id="chineseWord">‰∏≠ÊñáÈáä‰πâ</div>
            <div class="word-hint" id="wordHint"></div>

            <!-- English Word Input -->
            <div class="input-container">
                <input type="text" class="english-input" id="englishInput"
                       placeholder="ËæìÂÖ•Ëã±ËØ≠ÂçïËØç..." autocomplete="off"
                       onkeydown="handleKeydown(event)">
            </div>

            <!-- Part of Speech Selection -->
            <div class="pos-selection">
                <div class="pos-label">ÈÄâÊã©ËØçÊÄß (Part of Speech)</div>
                <div class="pos-buttons" id="posButtons">
                    <button type="button" class="pos-btn" data-pos="n." onclick="selectPos('n.')">n.</button>
                    <button type="button" class="pos-btn" data-pos="v." onclick="selectPos('v.')">v.</button>
                    <button type="button" class="pos-btn" data-pos="adj." onclick="selectPos('adj.')">adj.</button>
                    <button type="button" class="pos-btn" data-pos="adv." onclick="selectPos('adv.')">adv.</button>
                    <button type="button" class="pos-btn" data-pos="prep." onclick="selectPos('prep.')">prep.</button>
                    <button type="button" class="pos-btn" data-pos="pron." onclick="selectPos('pron.')">pron.</button>
                    <button type="button" class="pos-btn" data-pos="conj." onclick="selectPos('conj.')">conj.</button>
                </div>
            </div>

            <button class="check-btn" id="checkBtn" onclick="checkAnswer()">Ê£ÄÊü•Á≠îÊ°à</button>

            <div class="feedback" id="feedback">
                <span id="feedbackIcon"></span>
                <span id="feedbackText"></span>
                <div class="correct-answer" id="correctAnswer"></div>
                <div class="answer-details" id="answerDetails"></div>
                <button class="retry-btn hidden" id="retryBtn" onclick="retryAnswer()">ÈáçÊñ∞‰ΩúÁ≠î</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="practice-card results-screen" id="resultsScreen">
            <div class="results-header">
                <h2 class="results-title">ÁªÉ‰π†ÂÆåÊàêÔºÅ</h2>
                <div class="results-score" id="resultsScore">0/0</div>
                <div class="results-percentage" id="resultsPercentage">Ê≠£Á°ÆÁéá: 0%</div>
            </div>

            <div class="wrong-words-section" id="wrongWordsSection">
                <h3 class="wrong-words-title">ÈîôËØØÂçïËØç</h3>
                <div id="wrongWordsList"></div>
            </div>

            <div class="unit-stats hidden" id="unitStats">
                <h3 class="unit-stats-title">ÂêÑÂçïÂÖÉÊ≠£Á°ÆÁéá</h3>
                <div id="unitStatsList"></div>
            </div>

            <div class="results-actions">
                <button class="redo-wrong-btn" id="redoWrongBtn" onclick="redoWrongWords()">ÈáçÂÅöÈîôÈ¢ò</button>
                <button class="action-btn restart-btn" onclick="restartPractice()">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>
        </div>

        <!-- Control Card -->
        <div class="control-card" id="controlCard">
            <div class="control-row" id="unitControls">
                <div class="control-group">
                    <label class="control-label">ÈÄâÊã©ÂçïÂÖÉ</label>
                    <select class="control-select" id="unitSelect" onchange="onUnitChange()">
                        <!-- Dynamically populated from vocabularyData -->
                    </select>
                </div>
            </div>

            <div class="control-row hidden" id="randomControls">
                <div class="control-group">
                    <label class="control-label">È¢òÁõÆÊï∞Èáè</label>
                    <select class="control-select" id="questionCount">
                        <option value="10">10 È¢ò</option>
                        <option value="15">15 È¢ò</option>
                        <option value="20">20 È¢ò</option>
                        <option value="25">25 È¢ò</option>
                    </select>
                </div>
            </div>

            <div class="control-row">
                <button class="action-btn next-btn" id="nextBtn" onclick="nextWord()" disabled>‰∏ã‰∏ÄÈ¢ò</button>
                <button class="action-btn restart-btn" onclick="restartPractice()">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">Ê≠£Á°Æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrongCount">0</div>
                    <div class="stat-label">ÈîôËØØ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">ÊÄªËÆ°</div>
                </div>
            </div>

            <div class="storage-section">
                <button class="clear-storage-btn" onclick="clearStorage()">Ê∏ÖÈô§Â≠¶‰π†ËÆ∞ÂΩï</button>
            </div>
        </div>
    </main>

    <!-- ‰æßËæπÊ†èÁªüËÆ°Èù¢Êùø -->
    <aside class="stats-sidebar collapsed" id="statsSidebar">
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
            <span class="toggle-icon">üìä</span>
            <span class="toggle-text">ÁªüËÆ°</span>
        </button>
        <div class="sidebar-content" id="sidebarContent">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Â≠¶‰π†ÁªüËÆ°</h3>
                <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
            </div>

            <!-- ÊÄª‰ΩìÁªüËÆ° -->
            <div class="stats-section">
                <h4 class="section-title">ÊÄª‰ΩìËøõÂ∫¶</h4>
                <div class="stat-row">
                    <span class="stat-icon">üìù</span>
                    <span class="stat-name">ÊÄªÁªÉ‰π†Ê¨°Êï∞</span>
                    <span class="stat-number" id="totalAttemptsSidebar">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">‚úì</span>
                    <span class="stat-name">ÊÄª‰ΩìÊ≠£Á°ÆÁéá</span>
                    <span class="stat-number" id="totalAccuracySidebar">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">üìö</span>
                    <span class="stat-name">Â∑≤Â≠¶ÂçïËØç</span>
                    <span class="stat-number" id="wordsLearnedSidebar">0</span>
                </div>
                <div class="stat-row highlight">
                    <span class="stat-icon">‚≠ê</span>
                    <span class="stat-name">Â∑≤ÊéåÊè°</span>
                    <span class="stat-number" id="wordsMasteredSidebar">0</span>
                </div>
                <div class="mastery-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="masteryProgressSidebar"></div>
                    </div>
                    <span class="progress-text" id="masteryTextSidebar">0/0 ÂçïËØç</span>
                </div>
            </div>

            <!-- ‰ªäÊó•ÁªüËÆ° -->
            <div class="stats-section today-section">
                <h4 class="section-title">‰ªäÊó•Â≠¶‰π†</h4>
                <div class="stat-row">
                    <span class="stat-icon">üìÖ</span>
                    <span class="stat-name">‰ªäÊó•ÁªÉ‰π†</span>
                    <span class="stat-number" id="todayAttemptsSidebar">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-icon">üéØ</span>
                    <span class="stat-name">‰ªäÊó•Ê≠£Á°ÆÁéá</span>
                    <span class="stat-number" id="todayAccuracySidebar">0%</span>
                </div>
            </div>

            <!-- Â≠¶‰π†ÊèêÁ§∫ -->
            <div class="stats-tip" id="statsTipSidebar">
                ÂºÄÂßãÁªÉ‰π†ÂêßÔºÅ
            </div>
        </div>
    </aside>

    <!-- ‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <script src="eng_vocabulary.js"></script>
    <script>
        // App State
        let currentMode = 'unit';
        let currentWords = [];
        let currentIndex = 0;
        let correctAnswers = 0;
        let wrongWords = [];
        let answered = false;
        let unitStats = {};
        let selectedPos = null;
        let streak = 0;

        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const practiceCard = document.getElementById('practiceCard');
        const resultsScreen = document.getElementById('resultsScreen');
        const controlCard = document.getElementById('controlCard');
        const unitControls = document.getElementById('unitControls');
        const randomControls = document.getElementById('randomControls');
        const englishInput = document.getElementById('englishInput');
        const posButtons = document.getElementById('posButtons');
        const chineseWord = document.getElementById('chineseWord');
        const wordHint = document.getElementById('wordHint');
        const feedback = document.getElementById('feedback');
        const feedbackIcon = document.getElementById('feedbackIcon');
        const feedbackText = document.getElementById('feedbackText');
        const correctAnswer = document.getElementById('correctAnswer');
        const answerDetails = document.getElementById('answerDetails');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');
        const retryBtn = document.getElementById('retryBtn');
        const progressBadge = document.getElementById('progressBadge');

        // Initialize
        function init() {
            loadProgress();
            updateStats();

            // Populate unit selector from vocabularyData
            const unitSelect = document.getElementById('unitSelect');
            const units = Object.keys(vocabularyData.units).sort((a, b) => {
                // Sort by unit number
                const numA = parseInt(a.match(/\d+/)[0]);
                const numB = parseInt(b.match(/\d+/)[0]);
                return numA - numB;
            });
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
        }

        // Select Part of Speech
        function selectPos(pos) {
            if (answered) return;

            selectedPos = pos;

            // Update button states
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.pos === pos) {
                    btn.classList.add('selected');
                }
            });
        }

        // Mode Switch
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            unitControls.classList.toggle('hidden', mode !== 'unit');
            randomControls.classList.toggle('hidden', mode !== 'random');

            // Reset to welcome state
            showWelcome();
        }

        // Show Welcome
        function showWelcome() {
            welcomeScreen.classList.remove('hidden');
            practiceCard.classList.add('hidden');
            resultsScreen.classList.remove('show');
            resetState();
        }

        // Start Practice
        function startPractice() {
            welcomeScreen.classList.add('hidden');
            practiceCard.classList.remove('hidden');
            resultsScreen.classList.remove('show');

            if (currentMode === 'unit') {
                const unit = document.getElementById('unitSelect').value;
                const unitWords = vocabularyData.units[unit].words.map(w => ({
                    ...w,
                    unit: unit
                }));
                currentWords = shuffleArray(unitWords);
            } else if (currentMode === 'random') {
                const count = parseInt(document.getElementById('questionCount').value);
                currentWords = getRandomWords(count);
            }

            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            unitStats = {};
            streak = 0;

            showCurrentWord();
            updateStats();
            document.getElementById('streakStat').classList.remove('active');
        }

        // Get Random Words
        function getRandomWords(count) {
            const allWords = [];
            for (const [unit, unitData] of Object.entries(vocabularyData.units)) {
                unitData.words.forEach(word => {
                    allWords.push({
                        ...word,
                        unit: unit
                    });
                });
            }
            return shuffleArray(allWords).slice(0, Math.min(count, allWords.length));
        }

        // Shuffle Array
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Show Current Word
        function showCurrentWord() {
            if (currentIndex >= currentWords.length) {
                showResults();
                return;
            }

            const word = currentWords[currentIndex];

            chineseWord.textContent = word.chinese;
            wordHint.textContent = word.phonetic ? `Èü≥Ê†á: ${word.phonetic}` : '';

            // Clear and reset inputs
            englishInput.value = '';
            englishInput.className = 'english-input';
            englishInput.disabled = false;
            englishInput.placeholder = 'ËæìÂÖ•Ëã±ËØ≠ÂçïËØç...';
            englishInput.focus();

            // Reset POS buttons
            selectedPos = null;
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.className = 'pos-btn';
                btn.disabled = false;
            });

            feedback.classList.remove('show', 'correct', 'incorrect', 'partial');
            answerDetails.innerHTML = '';
            checkBtn.disabled = false;
            nextBtn.disabled = true;
            answered = false;

            updateProgress();
        }

        // Handle Keydown
        function handleKeydown(event) {
            if (event.key === 'Enter') {
                if (!answered) {
                    checkAnswer();
                } else {
                    nextWord();
                }
            }
        }

        // Normalize POS for comparison
        function normalizePos(pos) {
            if (!pos) return '';
            // Remove parentheses and trim
            pos = pos.toLowerCase().trim();
            // Handle variations
            const mapping = {
                'n.': 'n.',
                'noun': 'n.',
                'v.': 'v.',
                'verb': 'v.',
                'adj.': 'adj.',
                'adjective': 'adj.',
                'adv.': 'adv.',
                'adverb': 'adv.',
                'prep.': 'prep.',
                'preposition': 'prep.',
                'pron.': 'pron.',
                'pronoun': 'pron.',
                'conj.': 'conj.',
                'conjunction': 'conj.',
                'num.': 'num.',
                'det.': 'det.',
                'excl.': 'excl.',
                'modal v.': 'v.',  // Modal verbs are a type of verb
            };
            return mapping[pos] || pos;
        }

        // Check Answer
        function checkAnswer() {
            if (answered) return;

            const word = currentWords[currentIndex];
            const userWord = englishInput.value.trim().toLowerCase();
            const correctWord = word.word.toLowerCase();
            const userPos = selectedPos || '';
            const correctPos = word.partOfSpeech;

            // Check word spelling (case-insensitive)
            const wordCorrect = userWord === correctWord;

            // Check part of speech (normalized comparison)
            const normalizedUserPos = normalizePos(userPos);
            const normalizedCorrectPos = normalizePos(correctPos);
            const posCorrect = normalizedUserPos === normalizedCorrectPos;

            const isFullyCorrect = wordCorrect && posCorrect;

            // Update input styles
            englishInput.disabled = true;
            englishInput.classList.add(wordCorrect ? 'correct' : 'incorrect');

            // Update POS button styles
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.disabled = true;
                const btnPos = normalizePos(btn.dataset.pos);
                if (btnPos === normalizedCorrectPos) {
                    if (posCorrect) {
                        btn.classList.add('correct');
                    } else {
                        btn.classList.add('show-correct');
                    }
                } else if (btn.dataset.pos === userPos && !posCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            // Build details HTML
            const detailsHtml = `
                <div class="answer-detail-row">
                    <span class="detail-label">ÂçïËØçÊãºÂÜô:</span>
                    <span class="detail-value ${wordCorrect ? 'correct-val' : 'incorrect-val'}">
                        ${userWord || '(Á©∫)'} ${wordCorrect ? '‚úì' : '‚Üí ' + word.word}
                    </span>
                </div>
                <div class="answer-detail-row">
                    <span class="detail-label">ËØçÊÄß:</span>
                    <span class="detail-value ${posCorrect ? 'correct-val' : 'incorrect-val'}">
                        ${userPos || '(Êú™ÈÄâ)'} ${posCorrect ? '‚úì' : '‚Üí ' + correctPos}
                    </span>
                </div>
            `;

            // Determine feedback type
            const correctCount = [wordCorrect, posCorrect].filter(x => x).length;

            if (isFullyCorrect) {
                feedback.classList.add('show', 'correct');
                feedbackIcon.textContent = '‚úì';
                feedbackText.textContent = 'ÂÆåÂÖ®Ê≠£Á°ÆÔºÅ';
                correctAnswer.textContent = '';
                retryBtn.classList.add('hidden');
            } else if (correctCount > 0) {
                feedback.classList.add('show', 'partial');
                feedbackIcon.textContent = '~';
                feedbackText.textContent = `ÈÉ®ÂàÜÊ≠£Á°Æ (${correctCount}/2)`;
                correctAnswer.textContent = `ÂÆåÊï¥Á≠îÊ°à: ${word.word} (${correctPos})`;
                retryBtn.classList.remove('hidden');
            } else {
                feedback.classList.add('show', 'incorrect');
                feedbackIcon.textContent = '‚úó';
                feedbackText.textContent = 'ÈîôËØØ';
                correctAnswer.textContent = `Ê≠£Á°ÆÁ≠îÊ°à: ${word.word} (${correctPos})`;
                retryBtn.classList.remove('hidden');
            }

            answerDetails.innerHTML = detailsHtml;
            answered = true;
            checkBtn.disabled = true;
            nextBtn.disabled = false;

            // Update stats (‰ΩøÁî®Êñ∞ÁâàÊú¨ÂáΩÊï∞)
            updateWordProgressV2(word.word, isFullyCorrect);

            if (isFullyCorrect) {
                correctAnswers++;
                streak++;
                checkStreakEncouragement();
            } else {
                wrongWords.push(word);
                if (streak > 0) {
                    streak = 0;
                }
            }

            // Track unit stats for random mode
            if (currentMode === 'random') {
                if (!unitStats[word.unit]) {
                    unitStats[word.unit] = { correct: 0, total: 0 };
                }
                unitStats[word.unit].total++;
                if (isFullyCorrect) {
                    unitStats[word.unit].correct++;
                }
            }

            updateStats(isFullyCorrect);
        }

        // Retry Answer
        function retryAnswer() {
            const word = currentWords[currentIndex];

            // Reset answered state
            answered = false;

            // Hide feedback and retry button
            feedback.classList.remove('show', 'correct', 'incorrect', 'partial');
            retryBtn.classList.add('hidden');
            answerDetails.innerHTML = '';
            correctAnswer.textContent = '';

            // Re-enable check button, disable next button
            checkBtn.disabled = false;
            nextBtn.disabled = true;

            // Reset input
            englishInput.value = '';
            englishInput.className = 'english-input';
            englishInput.disabled = false;
            englishInput.focus();

            // Reset POS buttons
            selectedPos = null;
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.className = 'pos-btn';
                btn.disabled = false;
            });

            // Remove from wrong words list if it was added
            const wrongIndex = wrongWords.indexOf(word);
            if (wrongIndex !== -1) {
                wrongWords.splice(wrongIndex, 1);
            }

            updateStats();
        }

        // Next Word
        function nextWord() {
            currentIndex++;
            showCurrentWord();
        }

        // Show Results
        function showResults() {
            practiceCard.classList.add('hidden');
            resultsScreen.classList.add('show');

            const total = currentWords.length;
            const percentage = total > 0 ? Math.round((correctAnswers / total) * 100) : 0;

            document.getElementById('resultsScore').textContent = `${correctAnswers}/${total}`;
            document.getElementById('resultsPercentage').textContent = `Ê≠£Á°ÆÁéá: ${percentage}%`;

            // Show special encouragement for perfect score
            if (percentage === 100 && total > 0) {
                setTimeout(() => {
                    showEncouragement('Êª°ÂàÜÔºÅÊÅ≠Âñú‰Ω†ÔºÅ', true);
                }, 500);
            } else if (percentage >= 80) {
                setTimeout(() => {
                    showEncouragement('ÂÅöÂæóÂæàÂ•ΩÔºÅÁªßÁª≠Âä™ÂäõÔºÅ');
                }, 500);
            }

            // Wrong words section
            const wrongWordsSection = document.getElementById('wrongWordsSection');
            const wrongWordsList = document.getElementById('wrongWordsList');
            const redoWrongBtn = document.getElementById('redoWrongBtn');

            if (wrongWords.length > 0) {
                wrongWordsSection.classList.remove('hidden');
                redoWrongBtn.classList.remove('hidden');
                wrongWordsList.innerHTML = wrongWords.map(word => `
                    <div class="wrong-word-item">
                        <span class="wrong-english">${word.word} <span class="wrong-pos">(${word.partOfSpeech})</span></span>
                        <span class="wrong-chinese">${word.chinese}</span>
                    </div>
                `).join('');
            } else {
                wrongWordsSection.classList.add('hidden');
                redoWrongBtn.classList.add('hidden');
            }

            // Unit stats for random mode
            const unitStatsSection = document.getElementById('unitStats');
            const unitStatsList = document.getElementById('unitStatsList');

            if (currentMode === 'random' && Object.keys(unitStats).length > 0) {
                unitStatsSection.classList.remove('hidden');
                unitStatsList.innerHTML = Object.entries(unitStats)
                    .sort((a, b) => {
                        const numA = parseInt(a[0].match(/\d+/)[0]);
                        const numB = parseInt(b[0].match(/\d+/)[0]);
                        return numA - numB;
                    })
                    .map(([unit, stats]) => {
                        const pct = Math.round((stats.correct / stats.total) * 100);
                        return `
                            <div class="unit-stat-item">
                                <span class="unit-stat-name">${unit}</span>
                                <div class="unit-stat-bar">
                                    <div class="unit-stat-fill" style="width: ${pct}%"></div>
                                </div>
                                <span class="unit-stat-value">${stats.correct}/${stats.total}</span>
                            </div>
                        `;
                    }).join('');
            } else {
                unitStatsSection.classList.add('hidden');
            }
        }

        // Redo Wrong Words
        function redoWrongWords() {
            if (wrongWords.length === 0) return;

            currentWords = shuffleArray([...wrongWords]);
            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            unitStats = {};
            streak = 0;

            resultsScreen.classList.remove('show');
            practiceCard.classList.remove('hidden');

            showCurrentWord();
            updateStats();
            document.getElementById('streakStat').classList.remove('active');
        }

        // Restart Practice
        function restartPractice() {
            startPractice();
        }

        // Reset State
        function resetState() {
            currentWords = [];
            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            answered = false;
            unitStats = {};
            streak = 0;
            updateStats();
            updateProgress();
            document.getElementById('streakStat').classList.remove('active');
        }

        // On Unit Change
        function onUnitChange() {
            if (!welcomeScreen.classList.contains('hidden')) return;
            startPractice();
        }

        // Update Progress Badge
        function updateProgress() {
            const total = currentWords.length;
            const current = Math.min(currentIndex + 1, total);
            progressBadge.textContent = total > 0 ? `${current}/${total}` : '0/0';
        }

        // Update Stats Display
        function updateStats(isCorrectAnswer = null) {
            const total = currentIndex + (answered ? 1 : 0);
            const wrongCount = wrongWords.length;
            const rate = total > 0 ? Math.round((correctAnswers / total) * 100) : 0;

            // Update top stats bar
            document.getElementById('correctCountTop').textContent = correctAnswers;
            document.getElementById('wrongCountTop').textContent = wrongCount;
            document.getElementById('rateValue').textContent = rate + '%';
            document.getElementById('streakValue').textContent = streak;

            // Update old stats (kept for compatibility)
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = total;

            // Animate stats on answer
            if (isCorrectAnswer === true) {
                animateStat('correctStat', 'animate-correct');
                // Activate streak glow if streak > 0
                const streakStat = document.getElementById('streakStat');
                if (streak > 0) {
                    streakStat.classList.add('active');
                }
            } else if (isCorrectAnswer === false) {
                animateStat('wrongStat', 'animate-wrong');
                // Remove streak glow
                document.getElementById('streakStat').classList.remove('active');
            }
        }

        // Animate a stat element
        function animateStat(elementId, animationClass) {
            const element = document.getElementById(elementId);
            element.classList.remove(animationClass);
            // Trigger reflow to restart animation
            void element.offsetWidth;
            element.classList.add(animationClass);

            // Remove animation class after it completes
            setTimeout(() => {
                element.classList.remove(animationClass);
            }, 500);
        }

        // Show encouragement message
        function showEncouragement(message, isPerfect = false) {
            const encouragement = document.getElementById('encouragement');
            encouragement.textContent = message;
            encouragement.classList.remove('perfect');
            if (isPerfect) {
                encouragement.classList.add('perfect');
            }
            encouragement.classList.add('show');

            setTimeout(() => {
                encouragement.classList.remove('show');
            }, 2000);
        }

        // Check and show streak encouragement
        function checkStreakEncouragement() {
            if (streak === 3) {
                showEncouragement('‰∏çÈîôÔºÅÁªßÁª≠‰øùÊåÅÔºÅ');
            } else if (streak === 5) {
                showEncouragement('Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÁúüÂéâÂÆ≥ÔºÅ');
            } else if (streak === 10) {
                showEncouragement('ÂÆåÁæéÔºÅ‰Ω†ÊòØËã±ËØ≠Ëææ‰∫∫ÔºÅ', true);
            } else if (streak === 15) {
                showEncouragement('Êó†ÊïåÔºÅÊó†‰∫∫ËÉΩÊå°ÔºÅ', true);
            } else if (streak === 20) {
                showEncouragement('‰º†Â•áÔºÅËã±ËØ≠‰πãÁ•ûÔºÅ', true);
            }
        }

        // LocalStorage Functions
        function loadProgress() {
            try {
                const data = localStorage.getItem('englishVocabProgress');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }

        function saveProgress(progress) {
            try {
                localStorage.setItem('englishVocabProgress', JSON.stringify(progress));
            } catch (e) {
                console.error('Failed to save progress:', e);
            }
        }

        function updateWordProgress(word, isCorrect) {
            const progress = loadProgress();
            if (!progress[word]) {
                progress[word] = { attempts: 0, correct: 0 };
            }
            progress[word].attempts++;
            if (isCorrect) {
                progress[word].correct++;
            }
            saveProgress(progress);
        }

        function clearStorage() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂ≠¶‰π†ËÆ∞ÂΩïÂêóÔºü')) {
                localStorage.removeItem('englishVocabProgress');
                localStorage.removeItem('englishVocabProgress_v2');
                // ÈáçÊñ∞ÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆ
                initializeStatsData();
                updateSidebarStats();
                alert('Â≠¶‰π†ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§');
            }
        }

        // ==================== ‰æßËæπÊ†èÁªüËÆ°ÂäüËÉΩ ====================

        const STORAGE_VERSION = 2;
        const STORAGE_KEY_V2 = 'englishVocabProgress_v2';

        // Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•ÊúüÂ≠óÁ¨¶‰∏≤
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // ÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆÁªìÊûÑ
        function initializeStatsData() {
            let data = loadStatsData();

            if (!data) {
                data = migrateOldData();
            }

            // Ê£ÄÊü•Âπ∂ÈáçÁΩÆ‰ªäÊó•ÁªüËÆ°ÔºàÂ¶ÇÊûúÊó•ÊúüÂèòÊõ¥Ôºâ
            if (data.todayStats.date !== getTodayDateString()) {
                data.todayStats = {
                    date: getTodayDateString(),
                    attempts: 0,
                    correct: 0
                };
                saveStatsData(data);
            }

            return data;
        }

        // ËøÅÁßªÊóßÊï∞ÊçÆÂà∞Êñ∞ÁªìÊûÑ
        function migrateOldData() {
            const oldData = loadProgress();

            const newData = {
                version: STORAGE_VERSION,
                totalStats: {
                    totalAttempts: 0,
                    totalCorrect: 0,
                    wordsLearned: 0,
                    wordsMastered: 0
                },
                todayStats: {
                    date: getTodayDateString(),
                    attempts: 0,
                    correct: 0
                },
                words: {}
            };

            if (oldData && typeof oldData === 'object') {
                for (const [word, stats] of Object.entries(oldData)) {
                    if (stats && typeof stats === 'object') {
                        newData.words[word] = {
                            attempts: stats.attempts || 0,
                            correct: stats.correct || 0,
                            lastPracticed: null
                        };

                        newData.totalStats.totalAttempts += stats.attempts || 0;
                        newData.totalStats.totalCorrect += stats.correct || 0;

                        if (stats.attempts > 0) {
                            newData.totalStats.wordsLearned++;

                            if (stats.attempts >= 3) {
                                const accuracy = stats.correct / stats.attempts;
                                if (accuracy >= 0.8) {
                                    newData.totalStats.wordsMastered++;
                                }
                            }
                        }
                    }
                }
            }

            saveStatsData(newData);
            return newData;
        }

        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        function loadStatsData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY_V2);
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.version === STORAGE_VERSION) {
                        return parsed;
                    }
                }
                return null;
            } catch (e) {
                console.error('Failed to load stats data:', e);
                return null;
            }
        }

        // ‰øùÂ≠òÁªüËÆ°Êï∞ÊçÆ
        function saveStatsData(data) {
            try {
                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save stats data:', e);
            }
        }

        // Âà§Êñ≠ÂçïËØçÊòØÂê¶ÊéåÊè°
        function isMastered(wordStats) {
            if (!wordStats || wordStats.attempts < 3) return false;
            return (wordStats.correct / wordStats.attempts) >= 0.8;
        }

        // Ëé∑ÂèñÊÄªËØçÊ±áÊï∞Èáè
        function getTotalWordCount() {
            let count = 0;
            for (const unit of Object.values(vocabularyData.units)) {
                count += unit.words.length;
            }
            return count;
        }

        // Êõ¥Êñ∞ÂçïËØçÁªÉ‰π†ËÆ∞ÂΩïÔºàÊñ∞ÁâàÊú¨Ôºâ
        function updateWordProgressV2(word, isCorrect) {
            const data = initializeStatsData();
            const today = getTodayDateString();

            // Êõ¥Êñ∞ÊÄª‰ΩìÁªüËÆ°
            data.totalStats.totalAttempts++;
            if (isCorrect) {
                data.totalStats.totalCorrect++;
            }

            // Êõ¥Êñ∞‰ªäÊó•ÁªüËÆ°
            if (data.todayStats.date !== today) {
                data.todayStats = { date: today, attempts: 0, correct: 0 };
            }
            data.todayStats.attempts++;
            if (isCorrect) {
                data.todayStats.correct++;
            }

            // Êõ¥Êñ∞ÂçïËØçËØ¶ÊÉÖ
            const isNewWord = !data.words[word] || data.words[word].attempts === 0;

            if (!data.words[word]) {
                data.words[word] = { attempts: 0, correct: 0, lastPracticed: null };
            }

            const wordStats = data.words[word];
            const wasMastered = isMastered(wordStats);

            wordStats.attempts++;
            if (isCorrect) {
                wordStats.correct++;
            }
            wordStats.lastPracticed = today;

            const nowMastered = isMastered(wordStats);

            // Êõ¥Êñ∞Â∑≤Â≠¶ÂçïËØçÊï∞
            if (isNewWord) {
                data.totalStats.wordsLearned++;
            }

            // Êõ¥Êñ∞Â∑≤ÊéåÊè°ÂçïËØçÊï∞
            if (!wasMastered && nowMastered) {
                data.totalStats.wordsMastered++;
            } else if (wasMastered && !nowMastered) {
                data.totalStats.wordsMastered = Math.max(0, data.totalStats.wordsMastered - 1);
            }

            saveStatsData(data);

            // ÂêåÊó∂Êõ¥Êñ∞ÊóßÊ†ºÂºè‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
            updateWordProgress(word, isCorrect);

            // Êõ¥Êñ∞‰æßËæπÊ†èÊòæÁ§∫
            updateSidebarStats();
        }

        // Êõ¥Êñ∞‰æßËæπÊ†èÊòæÁ§∫
        function updateSidebarStats() {
            const data = initializeStatsData();
            const totalWords = getTotalWordCount();

            // ÊÄª‰ΩìÁªüËÆ°
            document.getElementById('totalAttemptsSidebar').textContent = data.totalStats.totalAttempts;

            const totalAccuracy = data.totalStats.totalAttempts > 0
                ? Math.round((data.totalStats.totalCorrect / data.totalStats.totalAttempts) * 100)
                : 0;
            document.getElementById('totalAccuracySidebar').textContent = totalAccuracy + '%';

            document.getElementById('wordsLearnedSidebar').textContent = data.totalStats.wordsLearned;
            document.getElementById('wordsMasteredSidebar').textContent = data.totalStats.wordsMastered;

            // ÊéåÊè°ËøõÂ∫¶
            const masteryPercent = totalWords > 0
                ? Math.round((data.totalStats.wordsMastered / totalWords) * 100)
                : 0;
            document.getElementById('masteryProgressSidebar').style.width = masteryPercent + '%';
            document.getElementById('masteryTextSidebar').textContent =
                `${data.totalStats.wordsMastered}/${totalWords} ÂçïËØç`;

            // ‰ªäÊó•ÁªüËÆ°
            document.getElementById('todayAttemptsSidebar').textContent = data.todayStats.attempts;

            const todayAccuracy = data.todayStats.attempts > 0
                ? Math.round((data.todayStats.correct / data.todayStats.attempts) * 100)
                : 0;
            document.getElementById('todayAccuracySidebar').textContent = todayAccuracy + '%';

            // Êõ¥Êñ∞Â≠¶‰π†ÊèêÁ§∫
            updateStatsTip(data, totalWords);
        }

        // Êõ¥Êñ∞Â≠¶‰π†ÊèêÁ§∫
        function updateStatsTip(data, totalWords) {
            const tip = document.getElementById('statsTipSidebar');

            if (data.todayStats.attempts === 0) {
                tip.textContent = '‰ªäÂ§©ËøòÊ≤°ÂºÄÂßãÁªÉ‰π†ÔºåÂä†Ê≤πÔºÅ';
                tip.style.background = '#fff8e1';
                tip.style.borderColor = '#ffc107';
                tip.style.color = '#f57c00';
            } else if (data.todayStats.attempts >= 50) {
                tip.textContent = '‰ªäÂ§©Â≠¶‰π†ÂæàÂä™ÂäõÔºÅÊ≥®ÊÑè‰ºëÊÅØ';
                tip.style.background = '#e8f5e9';
                tip.style.borderColor = '#4caf50';
                tip.style.color = '#2e7d32';
            } else if (data.totalStats.wordsMastered >= totalWords * 0.8) {
                tip.textContent = '‰Ω†Â∑≤ÁªèÊéåÊè°Â§ßÈÉ®ÂàÜÂçïËØç‰∫ÜÔºÅ';
                tip.style.background = 'linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%)';
                tip.style.borderColor = '#764ba2';
                tip.style.color = '#764ba2';
            } else {
                const remaining = totalWords - data.totalStats.wordsMastered;
                tip.textContent = `ËøòÊúâ ${remaining} ‰∏™ÂçïËØçÂæÖÊéåÊè°`;
                tip.style.background = '#e3f2fd';
                tip.style.borderColor = '#1976d2';
                tip.style.color = '#1565c0';
            }
        }

        // ‰æßËæπÊ†èÂàáÊç¢
        function toggleSidebar() {
            const sidebar = document.getElementById('statsSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                sidebar.classList.toggle('expanded');
                overlay.classList.toggle('show', sidebar.classList.contains('expanded'));
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }

        // ÂàùÂßãÂåñ‰æßËæπÊ†è
        function initSidebar() {
            // ÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆ
            initializeStatsData();

            // Êõ¥Êñ∞ÊòæÁ§∫
            updateSidebarStats();

            // Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ
            const sidebar = document.getElementById('statsSidebar');
            if (window.innerWidth >= 1200) {
                sidebar.classList.remove('collapsed');
            } else {
                sidebar.classList.add('collapsed');
            }

            // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
            window.addEventListener('resize', function() {
                const sidebar = document.getElementById('statsSidebar');
                const overlay = document.getElementById('sidebarOverlay');

                if (window.innerWidth >= 1200) {
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.remove('expanded');
                    overlay.classList.remove('show');
                } else if (window.innerWidth > 768) {
                    sidebar.classList.remove('expanded');
                    overlay.classList.remove('show');
                }
            });
        }

        // Initialize on load
        init();
        initSidebar();
    </script>
</body>
</html>
