<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德语单词练习</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
            color: #333;
        }

        /* Navigation Bar */
        .navbar {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .navbar-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .navbar-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-badge {
            background: #e8f4fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .mode-switch {
            display: flex;
            background: #f0f0f0;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #666;
        }

        .mode-btn.active {
            background: white;
            color: #1976d2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Main Practice Area */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .practice-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }

        .chinese-word {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .word-hint {
            font-size: 0.875rem;
            color: #888;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .input-container {
            margin-bottom: 1rem;
        }

        .german-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            text-align: center;
            transition: border-color 0.2s;
        }

        .german-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .german-input.correct {
            border-color: #4caf50;
            background-color: #f1f8e9;
        }

        .german-input.incorrect {
            border-color: #f44336;
            background-color: #ffebee;
        }

        /* Noun Input Container */
        .noun-input-container {
            display: none;
            margin-bottom: 1rem;
        }

        .noun-input-container.show {
            display: block;
        }

        .noun-input-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .noun-field {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .noun-field.article-field {
            flex: 0 0 auto;
        }

        /* Article Selection Buttons */
        .article-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .article-btn {
            padding: 0.6rem 1rem;
            font-size: 1.125rem;
            border: 2px solid #e0e0e0;
            background: #fafafa;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .article-btn:hover {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .article-btn.selected {
            border-color: #1976d2;
            background: #1976d2;
            color: white;
        }

        .article-btn.correct {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .article-btn.incorrect {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .article-btn.show-correct {
            border-color: #4caf50;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .article-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .noun-field.plural-field {
            flex: 0 0 100px;
        }

        .noun-field-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .noun-field-input {
            padding: 0.75rem;
            font-size: 1.125rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            text-align: center;
            transition: border-color 0.2s;
        }

        .noun-field-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .noun-field-input.correct {
            border-color: #4caf50;
            background-color: #f1f8e9;
        }

        .noun-field-input.incorrect {
            border-color: #f44336;
            background-color: #ffebee;
        }

        .noun-field-input.article-input {
            text-transform: lowercase;
        }

        /* Special Characters */
        .special-chars {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .char-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #ddd;
            background: #fafafa;
            border-radius: 0.375rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .char-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .char-btn:active {
            transform: scale(0.95);
        }

        /* Check Button */
        .check-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .check-btn:hover {
            background: #1565c0;
        }

        .check-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }

        /* Feedback Area */
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
        }

        .feedback.partial {
            background: #fff3e0;
            color: #e65100;
        }

        .correct-answer {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .answer-details {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            text-align: left;
            padding: 0.5rem;
            background: rgba(255,255,255,0.5);
            border-radius: 0.25rem;
        }

        .answer-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .answer-detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            font-weight: 600;
        }

        .detail-value.correct-val {
            color: #2e7d32;
        }

        .detail-value.incorrect-val {
            color: #c62828;
        }

        /* Control Area */
        .control-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .control-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .control-select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            background: white;
            cursor: pointer;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .next-btn {
            background: #4caf50;
            color: white;
        }

        .next-btn:hover {
            background: #43a047;
        }

        .next-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }

        .restart-btn {
            background: #ff9800;
            color: white;
        }

        .restart-btn:hover {
            background: #f57c00;
        }

        /* Top Stats Bar */
        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.75rem 1rem;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .stat-item-top {
            text-align: center;
            padding: 0.4rem 0.8rem;
            background: rgba(255,255,255,0.15);
            border-radius: 0.5rem;
            transition: transform 0.3s, background 0.3s;
            min-width: 60px;
        }

        .stat-item-top .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .stat-item-top .stat-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.85);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-item-top.correct-stat .stat-value {
            color: #a5d6a7;
        }

        .stat-item-top.wrong-stat .stat-value {
            color: #ef9a9a;
        }

        .stat-item-top.rate-stat .stat-value {
            color: #90caf9;
        }

        .stat-item-top.streak-stat {
            background: rgba(255,215,0,0.25);
            border: 1px solid rgba(255,215,0,0.5);
        }

        .stat-item-top.streak-stat .stat-value {
            color: #ffd700;
        }

        /* Bounce animation for correct answers */
        @keyframes bounce-correct {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.3); }
            60% { transform: scale(0.95); }
        }

        .stat-item-top.animate-correct {
            animation: bounce-correct 0.5s ease;
            background: rgba(76, 175, 80, 0.4);
        }

        /* Shake animation for wrong answers */
        @keyframes shake-wrong {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .stat-item-top.animate-wrong {
            animation: shake-wrong 0.4s ease;
            background: rgba(244, 67, 54, 0.4);
        }

        /* Streak glow animation */
        @keyframes streak-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,215,0,0.8), 0 0 25px rgba(255,165,0,0.5); }
        }

        .stat-item-top.streak-stat.active {
            animation: streak-glow 1.5s ease infinite;
        }

        /* Encouragement message */
        .encouragement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2.5rem;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .encouragement.show {
            opacity: 1;
            animation: pop-in 0.5s ease;
        }

        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .encouragement.perfect {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        }

        /* Old stats in control card - hidden */
        .stats {
            display: none;
        }

        /* Results Screen */
        .results-screen {
            display: none;
        }

        .results-screen.show {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            color: #1976d2;
        }

        .results-percentage {
            font-size: 1.25rem;
            color: #666;
        }

        .wrong-words-section {
            margin-top: 1.5rem;
        }

        .wrong-words-title {
            font-size: 1rem;
            color: #c62828;
            margin-bottom: 0.75rem;
        }

        .wrong-word-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: #fff8f8;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #f44336;
        }

        .wrong-german {
            font-weight: 600;
            color: #c62828;
        }

        .wrong-chinese {
            color: #666;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .redo-wrong-btn {
            flex: 1;
            padding: 0.75rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .redo-wrong-btn:hover {
            background: #d32f2f;
        }

        /* Grammar Practice */
        .grammar-question {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .grammar-prompt {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .grammar-prompt .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 2px solid #1976d2;
            margin: 0 0.25rem;
        }

        .grammar-hint {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .grammar-hint .noun-gender {
            font-weight: 600;
            color: #1976d2;
        }

        .grammar-context {
            font-size: 1rem;
            color: #666;
            margin-top: 0.25rem;
        }

        /* Retry Button */
        .retry-btn {
            margin-top: 0.75rem;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-btn:hover {
            background: #f57c00;
        }

        /* Lesson Stats (Random Mode) */
        .lesson-stats {
            margin-top: 1.5rem;
        }

        .lesson-stats-title {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 0.75rem;
        }

        .lesson-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .lesson-stat-name {
            color: #666;
        }

        .lesson-stat-bar {
            flex: 1;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .lesson-stat-fill {
            height: 100%;
            background: #4caf50;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .lesson-stat-value {
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        /* Storage Actions */
        .storage-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .clear-storage-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            cursor: pointer;
            color: #666;
        }

        .clear-storage-btn:hover {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 2rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .welcome-text {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .start-btn {
            padding: 1rem 2rem;
            font-size: 1.125rem;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .start-btn:hover {
            background: #1565c0;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .navbar-content {
                padding: 0 0.5rem;
            }

            .app-title {
                font-size: 1.25rem;
            }

            .practice-card {
                padding: 1.5rem 1rem;
            }

            .chinese-word {
                font-size: 1.75rem;
            }

            .german-input {
                font-size: 1.125rem;
            }

            .char-btn {
                width: 40px;
                height: 40px;
                font-size: 1.125rem;
            }

            .control-row {
                flex-direction: column;
            }

            .results-actions {
                flex-direction: column;
            }

            .stats {
                gap: 1rem;
            }

            .stats-bar {
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .stat-item-top {
                padding: 0.3rem 0.5rem;
                min-width: 50px;
            }

            .stat-item-top .stat-value {
                font-size: 1rem;
            }

            .stat-item-top .stat-label {
                font-size: 0.6rem;
            }

            .encouragement {
                font-size: 1.25rem;
                padding: 1rem 1.5rem;
            }

            .noun-input-row {
                flex-wrap: wrap;
            }

            .noun-field.article-field {
                flex: 1 1 100%;
                order: -2;
                margin-bottom: 0.5rem;
            }

            .article-buttons {
                justify-content: center;
            }

            .noun-field.plural-field {
                flex: 0 0 80px;
            }

            .noun-field.noun-word-field {
                flex: 1 1 60%;
                order: -1;
            }
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-top">
                <h1 class="app-title">德语单词练习</h1>
                <span class="progress-badge" id="progressBadge">0/0</span>
            </div>
            <div class="mode-switch">
                <button class="mode-btn active" data-mode="lesson" onclick="switchMode('lesson')">按课练习</button>
                <button class="mode-btn" data-mode="random" onclick="switchMode('random')">随机测试</button>
                <button class="mode-btn" data-mode="grammar" onclick="switchMode('grammar')">语法练习</button>
            </div>
        </div>
    </nav>

    <!-- Top Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-item-top correct-stat" id="correctStat">
            <div class="stat-value" id="correctCountTop">0</div>
            <div class="stat-label">正确</div>
        </div>
        <div class="stat-item-top wrong-stat" id="wrongStat">
            <div class="stat-value" id="wrongCountTop">0</div>
            <div class="stat-label">错误</div>
        </div>
        <div class="stat-item-top rate-stat" id="rateStat">
            <div class="stat-value" id="rateValue">0%</div>
            <div class="stat-label">正确率</div>
        </div>
        <div class="stat-item-top streak-stat" id="streakStat">
            <div class="stat-value" id="streakValue">0</div>
            <div class="stat-label">连对</div>
        </div>
    </div>

    <!-- Encouragement Message -->
    <div class="encouragement" id="encouragement"></div>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Welcome Screen -->
        <div class="practice-card welcome-screen" id="welcomeScreen">
            <h2 class="welcome-title">欢迎使用德语单词练习</h2>
            <p class="welcome-text">选择课次或随机测试开始练习</p>
            <button class="start-btn" onclick="startPractice()">开始练习</button>
        </div>

        <!-- Practice Card -->
        <div class="practice-card hidden" id="practiceCard">
            <div class="chinese-word" id="chineseWord">早晨</div>
            <div class="word-hint" id="wordHint"></div>

            <!-- Regular Input (for non-nouns) -->
            <div class="input-container" id="regularInputContainer">
                <input type="text" class="german-input" id="germanInput"
                       placeholder="输入德语单词..." autocomplete="off"
                       onkeydown="handleKeydown(event)">
            </div>

            <!-- Noun Input (for nouns with article and plural) -->
            <div class="noun-input-container" id="nounInputContainer">
                <div class="noun-input-row">
                    <div class="noun-field article-field">
                        <label class="noun-field-label">冠词</label>
                        <div class="article-buttons" id="articleButtons">
                            <button type="button" class="article-btn" data-article="der" onclick="selectArticle('der')">der</button>
                            <button type="button" class="article-btn" data-article="die" onclick="selectArticle('die')">die</button>
                            <button type="button" class="article-btn" data-article="das" onclick="selectArticle('das')">das</button>
                        </div>
                    </div>
                    <div class="noun-field noun-word-field">
                        <label class="noun-field-label">名词</label>
                        <input type="text" class="noun-field-input" id="nounInput"
                               placeholder="输入名词..." autocomplete="off"
                               onkeydown="handleKeydown(event)">
                    </div>
                    <div class="noun-field plural-field">
                        <label class="noun-field-label">复数</label>
                        <input type="text" class="noun-field-input" id="pluralInput"
                               placeholder="-/-e/¨er" autocomplete="off"
                               onkeydown="handleKeydown(event)">
                    </div>
                </div>
            </div>

            <div class="special-chars">
                <button class="char-btn" onclick="insertChar('ä')">ä</button>
                <button class="char-btn" onclick="insertChar('ö')">ö</button>
                <button class="char-btn" onclick="insertChar('ü')">ü</button>
                <button class="char-btn" onclick="insertChar('ß')">ß</button>
                <button class="char-btn" onclick="insertChar('Ä')">Ä</button>
                <button class="char-btn" onclick="insertChar('Ö')">Ö</button>
                <button class="char-btn" onclick="insertChar('Ü')">Ü</button>
                <button class="char-btn" onclick="insertChar('¨')">¨</button>
            </div>

            <button class="check-btn" id="checkBtn" onclick="checkAnswer()">检查答案</button>

            <div class="feedback" id="feedback">
                <span id="feedbackIcon"></span>
                <span id="feedbackText"></span>
                <div class="correct-answer" id="correctAnswer"></div>
                <div class="answer-details" id="answerDetails"></div>
                <button class="retry-btn hidden" id="retryBtn" onclick="retryAnswer()">重新作答</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="practice-card results-screen" id="resultsScreen">
            <div class="results-header">
                <h2 class="results-title">练习完成！</h2>
                <div class="results-score" id="resultsScore">0/0</div>
                <div class="results-percentage" id="resultsPercentage">正确率: 0%</div>
            </div>

            <div class="wrong-words-section" id="wrongWordsSection">
                <h3 class="wrong-words-title">错误单词</h3>
                <div id="wrongWordsList"></div>
            </div>

            <div class="lesson-stats hidden" id="lessonStats">
                <h3 class="lesson-stats-title">各课正确率</h3>
                <div id="lessonStatsList"></div>
            </div>

            <div class="results-actions">
                <button class="redo-wrong-btn" id="redoWrongBtn" onclick="redoWrongWords()">重做错题</button>
                <button class="action-btn restart-btn" onclick="restartPractice()">重新开始</button>
            </div>
        </div>

        <!-- Control Card -->
        <div class="control-card" id="controlCard">
            <div class="control-row" id="lessonControls">
                <div class="control-group">
                    <label class="control-label">选择课次</label>
                    <select class="control-select" id="lessonSelect" onchange="onLessonChange()">
                        <!-- Dynamically populated from vocabularyData -->
                    </select>
                </div>
            </div>

            <div class="control-row hidden" id="randomControls">
                <div class="control-group">
                    <label class="control-label">题目数量</label>
                    <select class="control-select" id="questionCount">
                        <option value="10">10 题</option>
                        <option value="15">15 题</option>
                        <option value="20">20 题</option>
                    </select>
                </div>
            </div>

            <div class="control-row hidden" id="grammarControls">
                <div class="control-group">
                    <label class="control-label">练习内容</label>
                    <select class="control-select" id="grammarType">
                        <option value="possessive">物主代词 (dein/mein/sein...)</option>
                        <option value="article">冠词 (ein/kein)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">题目数量</label>
                    <select class="control-select" id="grammarCount">
                        <option value="10">10 题</option>
                        <option value="15">15 题</option>
                        <option value="20">20 题</option>
                    </select>
                </div>
            </div>

            <div class="control-row">
                <button class="action-btn next-btn" id="nextBtn" onclick="nextWord()" disabled>下一题</button>
                <button class="action-btn restart-btn" onclick="restartPractice()">重新开始</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">正确</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrongCount">0</div>
                    <div class="stat-label">错误</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">总计</div>
                </div>
            </div>

            <div class="storage-section">
                <button class="clear-storage-btn" onclick="clearStorage()">清除学习记录</button>
            </div>
        </div>
    </main>

    <script src="vocabulary.js"></script>
    <script>
        // Convert normalized word to legacy format (for backward compatibility with existing UI logic)
        function toGermanString(word) {
            if (word.type === 'noun') {
                return `${word.article} ${word.word}, ${word.plural}`;
            }
            // Handle words with optional forms like dein/deine
            if (word.forms && word.forms.length > 1) {
                const base = word.forms[0];
                const ending = word.forms[1].slice(base.length);
                return `${base}(${ending})`;
            }
            return word.word;
        }

        // Convert normalized word to legacy object format
        function toLegacyWord(word, lesson) {
            const legacy = {
                german: toGermanString(word),
                chinese: word.chinese,
                lesson: lesson
            };
            if (word.verbType) {
                legacy.type = word.verbType;
            }
            return legacy;
        }

        // Get all nouns from vocabulary (using new normalized structure)
        function getAllNouns() {
            const nouns = [];
            for (const [lesson, lessonData] of Object.entries(vocabularyData.lessons)) {
                lessonData.words.forEach(word => {
                    if (word.type === 'noun') {
                        nouns.push({
                            article: word.article,
                            noun: word.word,
                            chinese: word.chinese,
                            lesson: lesson
                        });
                    }
                });
            }
            return nouns;
        }

        // Generate grammar questions
        function generateGrammarQuestions(type, count) {
            const items = vocabularyData.grammar[type];
            const nouns = getAllNouns();
            const questions = [];

            for (let i = 0; i < count; i++) {
                const item = items[Math.floor(Math.random() * items.length)];
                const noun = nouns[Math.floor(Math.random() * nouns.length)];

                // Determine correct form based on noun gender
                const isFeminine = noun.article === 'die';
                const correctForm = isFeminine ? item.feminine : item.base;

                questions.push({
                    type: 'grammar',
                    grammarType: type,
                    item: item,
                    noun: noun,
                    correctAnswer: correctForm,
                    isFeminine: isFeminine
                });
            }

            return shuffleArray(questions);
        }

        // App State
        let currentMode = 'lesson';
        let currentWords = [];
        let currentIndex = 0;
        let correctAnswers = 0;
        let wrongWords = [];
        let answered = false;
        let lessonStats = {};
        let activeInput = null; // Track which input is focused for special char insertion
        let selectedArticle = null; // Track selected article for noun input
        let streak = 0; // Track consecutive correct answers

        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const practiceCard = document.getElementById('practiceCard');
        const resultsScreen = document.getElementById('resultsScreen');
        const controlCard = document.getElementById('controlCard');
        const lessonControls = document.getElementById('lessonControls');
        const randomControls = document.getElementById('randomControls');
        const grammarControls = document.getElementById('grammarControls');
        const regularInputContainer = document.getElementById('regularInputContainer');
        const nounInputContainer = document.getElementById('nounInputContainer');
        const germanInput = document.getElementById('germanInput');
        const articleButtons = document.getElementById('articleButtons');
        const nounInput = document.getElementById('nounInput');
        const pluralInput = document.getElementById('pluralInput');
        const chineseWord = document.getElementById('chineseWord');
        const wordHint = document.getElementById('wordHint');
        const feedback = document.getElementById('feedback');
        const feedbackIcon = document.getElementById('feedbackIcon');
        const feedbackText = document.getElementById('feedbackText');
        const correctAnswer = document.getElementById('correctAnswer');
        const answerDetails = document.getElementById('answerDetails');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');
        const retryBtn = document.getElementById('retryBtn');
        const progressBadge = document.getElementById('progressBadge');

        // Parse noun from german string
        function parseNoun(german) {
            // Check if it's a noun (starts with der/die/das)
            const nounMatch = german.match(/^(der|die|das)\s+(.+?),\s*(.+)$/);
            if (nounMatch) {
                return {
                    isNoun: true,
                    article: nounMatch[1],
                    noun: nounMatch[2],
                    plural: nounMatch[3].trim()
                };
            }
            return { isNoun: false };
        }

        // Initialize
        function init() {
            loadProgress();
            updateStats();

            // Populate lesson selector from vocabularyData
            const lessonSelect = document.getElementById('lessonSelect');
            const lessons = Object.keys(vocabularyData.lessons).sort((a, b) => {
                // Sort by lesson number
                const numA = parseInt(a.match(/\d+/)[0]);
                const numB = parseInt(b.match(/\d+/)[0]);
                return numA - numB;
            });
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            });

            // Track active input for special character insertion
            [germanInput, nounInput, pluralInput].forEach(input => {
                input.addEventListener('focus', () => {
                    activeInput = input;
                });
            });
        }

        // Select Article
        function selectArticle(article) {
            if (answered) return;

            selectedArticle = article;

            // Update button states
            document.querySelectorAll('.article-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.article === article) {
                    btn.classList.add('selected');
                }
            });

            // Auto-focus on noun input after selecting article
            nounInput.focus();
            activeInput = nounInput;
        }

        // Mode Switch
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            lessonControls.classList.toggle('hidden', mode !== 'lesson');
            randomControls.classList.toggle('hidden', mode !== 'random');
            grammarControls.classList.toggle('hidden', mode !== 'grammar');

            // Reset to welcome state
            showWelcome();
        }

        // Show Welcome
        function showWelcome() {
            welcomeScreen.classList.remove('hidden');
            practiceCard.classList.add('hidden');
            resultsScreen.classList.remove('show');
            resetState();
        }

        // Start Practice
        function startPractice() {
            welcomeScreen.classList.add('hidden');
            practiceCard.classList.remove('hidden');
            resultsScreen.classList.remove('show');

            if (currentMode === 'lesson') {
                const lesson = document.getElementById('lessonSelect').value;
                const lessonWords = vocabularyData.lessons[lesson].words.map(w => toLegacyWord(w, lesson));
                currentWords = shuffleArray(lessonWords);
            } else if (currentMode === 'random') {
                const count = parseInt(document.getElementById('questionCount').value);
                currentWords = getRandomWords(count);
            } else if (currentMode === 'grammar') {
                const type = document.getElementById('grammarType').value;
                const count = parseInt(document.getElementById('grammarCount').value);
                currentWords = generateGrammarQuestions(type, count);
            }

            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            lessonStats = {};
            streak = 0;

            showCurrentWord();
            updateStats();
            document.getElementById('streakStat').classList.remove('active');
        }

        // Get Random Words
        function getRandomWords(count) {
            const allWords = [];
            for (const [lesson, lessonData] of Object.entries(vocabularyData.lessons)) {
                lessonData.words.forEach(word => {
                    allWords.push(toLegacyWord(word, lesson));
                });
            }
            return shuffleArray(allWords).slice(0, Math.min(count, allWords.length));
        }

        // Shuffle Array
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Show Current Word
        function showCurrentWord() {
            if (currentIndex >= currentWords.length) {
                showResults();
                return;
            }

            const word = currentWords[currentIndex];

            // Handle grammar mode differently
            if (word.type === 'grammar') {
                showGrammarQuestion(word);
                return;
            }

            const parsed = parseNoun(word.german);

            chineseWord.textContent = word.chinese;

            // Show appropriate input based on word type
            if (parsed.isNoun) {
                regularInputContainer.classList.add('hidden');
                nounInputContainer.classList.add('show');
                wordHint.textContent = '提示: 名词 - 选择冠词，输入名词和复数形式';

                // Clear and reset article buttons
                selectedArticle = null;
                document.querySelectorAll('.article-btn').forEach(btn => {
                    btn.className = 'article-btn';
                    btn.disabled = false;
                });

                // Clear and reset noun inputs
                nounInput.value = '';
                pluralInput.value = '';
                nounInput.className = 'noun-field-input';
                pluralInput.className = 'noun-field-input';
                nounInput.disabled = false;
                pluralInput.disabled = false;
                nounInput.focus();
                activeInput = nounInput;
            } else {
                regularInputContainer.classList.remove('hidden');
                nounInputContainer.classList.remove('show');
                wordHint.textContent = getWordHint(word);

                // Clear and reset regular input
                germanInput.value = '';
                germanInput.className = 'german-input';
                germanInput.disabled = false;
                germanInput.focus();
                activeInput = germanInput;
            }

            feedback.classList.remove('show', 'correct', 'incorrect', 'partial');
            answerDetails.innerHTML = '';
            checkBtn.disabled = false;
            nextBtn.disabled = true;
            answered = false;

            updateProgress();
        }

        // Show Grammar Question
        function showGrammarQuestion(question) {
            const noun = question.noun;
            const item = question.item;

            // Build the display
            chineseWord.innerHTML = `<span class="grammar-prompt"><span class="blank"></span> ${noun.noun}</span>`;

            const genderText = noun.article === 'der' ? '阳性' : (noun.article === 'die' ? '阴性' : '中性');
            const genderClass = noun.article === 'die' ? 'feminine' : '';

            wordHint.innerHTML = `
                <div class="grammar-hint">
                    名词: <span class="noun-gender">${noun.article} ${noun.noun}</span> (${genderText}) - ${noun.chinese}
                </div>
                <div class="grammar-context">
                    填写「${item.chinese}」的正确形式
                </div>
            `;

            // Show regular input for grammar
            regularInputContainer.classList.remove('hidden');
            nounInputContainer.classList.remove('show');

            // Clear and reset regular input
            germanInput.value = '';
            germanInput.className = 'german-input';
            germanInput.disabled = false;
            germanInput.placeholder = `${item.base} 或 ${item.feminine}`;
            germanInput.focus();
            activeInput = germanInput;

            feedback.classList.remove('show', 'correct', 'incorrect', 'partial');
            answerDetails.innerHTML = '';
            checkBtn.disabled = false;
            nextBtn.disabled = true;
            answered = false;

            updateProgress();
        }

        // Get Word Hint
        function getWordHint(word) {
            const hints = [];

            // Verb type hint
            if (word.type) {
                const typeNames = {
                    'vi': '不及物动词 (vi)',
                    'vt': '及物动词 (vt)',
                    'vr': '反身动词 (vr)'
                };
                hints.push(typeNames[word.type] || word.type);
            }

            // Optional form hint
            if (word.german.includes('(')) {
                hints.push('可变形式用括号表示');
            }

            return hints.length > 0 ? '提示: ' + hints.join('，') : '';
        }

        // Insert Special Character
        function insertChar(char) {
            if (!activeInput || activeInput.disabled) return;

            const input = activeInput;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;

            input.value = value.substring(0, start) + char + value.substring(end);
            input.selectionStart = input.selectionEnd = start + 1;
            input.focus();
        }

        // Handle Keydown
        function handleKeydown(event) {
            if (event.key === 'Enter') {
                if (!answered) {
                    checkAnswer();
                } else {
                    nextWord();
                }
            } else if (event.key === 'Tab' && !event.shiftKey) {
                // Allow Tab navigation between noun fields
                const word = currentWords[currentIndex];
                const parsed = parseNoun(word.german);
                if (parsed.isNoun) {
                    const inputs = [nounInput, pluralInput];
                    const currentIdx = inputs.indexOf(event.target);
                    if (currentIdx !== -1 && currentIdx < inputs.length - 1) {
                        event.preventDefault();
                        inputs[currentIdx + 1].focus();
                        activeInput = inputs[currentIdx + 1];
                    }
                }
            }
        }

        // Check Answer
        function checkAnswer() {
            if (answered) return;

            const word = currentWords[currentIndex];

            // Handle grammar questions
            if (word.type === 'grammar') {
                checkGrammarAnswer(word);
                return;
            }

            const parsed = parseNoun(word.german);
            let isCorrect = false;
            let detailsHtml = '';

            if (parsed.isNoun) {
                // Check noun with separate fields
                const userArticle = selectedArticle || '';
                const userNoun = nounInput.value.trim();
                const userPlural = pluralInput.value.trim();

                const articleCorrect = userArticle === parsed.article;
                const nounCorrect = userNoun === parsed.noun;
                const pluralCorrect = userPlural === parsed.plural;

                isCorrect = articleCorrect && nounCorrect && pluralCorrect;

                // Update article button styles
                document.querySelectorAll('.article-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.article === parsed.article) {
                        // This is the correct answer
                        if (articleCorrect) {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('show-correct');
                        }
                    } else if (btn.dataset.article === userArticle && !articleCorrect) {
                        // User selected wrong answer
                        btn.classList.add('incorrect');
                    }
                });

                // Update noun/plural field styles
                nounInput.classList.add(nounCorrect ? 'correct' : 'incorrect');
                pluralInput.classList.add(pluralCorrect ? 'correct' : 'incorrect');

                // Disable inputs
                nounInput.disabled = true;
                pluralInput.disabled = true;

                // Build details HTML
                detailsHtml = `
                    <div class="answer-detail-row">
                        <span class="detail-label">冠词:</span>
                        <span class="detail-value ${articleCorrect ? 'correct-val' : 'incorrect-val'}">
                            ${userArticle || '(未选)'} ${articleCorrect ? '✓' : '→ ' + parsed.article}
                        </span>
                    </div>
                    <div class="answer-detail-row">
                        <span class="detail-label">名词:</span>
                        <span class="detail-value ${nounCorrect ? 'correct-val' : 'incorrect-val'}">
                            ${userNoun || '(空)'} ${nounCorrect ? '✓' : '→ ' + parsed.noun}
                        </span>
                    </div>
                    <div class="answer-detail-row">
                        <span class="detail-label">复数:</span>
                        <span class="detail-value ${pluralCorrect ? 'correct-val' : 'incorrect-val'}">
                            ${userPlural || '(空)'} ${pluralCorrect ? '✓' : '→ ' + parsed.plural}
                        </span>
                    </div>
                `;

                // Determine feedback type
                const correctCount = [articleCorrect, nounCorrect, pluralCorrect].filter(x => x).length;

                if (isCorrect) {
                    feedback.classList.add('show', 'correct');
                    feedbackIcon.textContent = '✓';
                    feedbackText.textContent = '完全正确！';
                    correctAnswer.textContent = '';
                    retryBtn.classList.add('hidden');
                } else if (correctCount > 0) {
                    feedback.classList.add('show', 'partial');
                    feedbackIcon.textContent = '~';
                    feedbackText.textContent = `部分正确 (${correctCount}/3)`;
                    correctAnswer.textContent = `完整答案: ${word.german}`;
                    retryBtn.classList.remove('hidden');
                } else {
                    feedback.classList.add('show', 'incorrect');
                    feedbackIcon.textContent = '✗';
                    feedbackText.textContent = '错误';
                    correctAnswer.textContent = `正确答案: ${word.german}`;
                    retryBtn.classList.remove('hidden');
                }

            } else {
                // Check regular word
                const userAnswer = germanInput.value.trim();
                isCorrect = checkSpelling(userAnswer, word.german);

                germanInput.disabled = true;

                if (isCorrect) {
                    germanInput.classList.add('correct');
                    feedback.classList.add('show', 'correct');
                    feedbackIcon.textContent = '✓';
                    feedbackText.textContent = '正确！';
                    correctAnswer.textContent = '';
                    retryBtn.classList.add('hidden');
                } else {
                    germanInput.classList.add('incorrect');
                    feedback.classList.add('show', 'incorrect');
                    feedbackIcon.textContent = '✗';
                    feedbackText.textContent = '错误';
                    correctAnswer.textContent = `正确答案: ${word.german}`;
                    retryBtn.classList.remove('hidden');
                }
            }

            answerDetails.innerHTML = detailsHtml;
            answered = true;
            checkBtn.disabled = true;
            nextBtn.disabled = false;

            // Update stats
            updateWordProgress(word.german, isCorrect);

            if (isCorrect) {
                correctAnswers++;
                streak++;
                checkStreakEncouragement();
            } else {
                wrongWords.push(word);
                if (streak > 0) {
                    streak = 0;
                }
            }

            // Track lesson stats for random mode
            if (currentMode === 'random') {
                if (!lessonStats[word.lesson]) {
                    lessonStats[word.lesson] = { correct: 0, total: 0 };
                }
                lessonStats[word.lesson].total++;
                if (isCorrect) {
                    lessonStats[word.lesson].correct++;
                }
            }

            updateStats(isCorrect);
        }

        // Check Grammar Answer
        function checkGrammarAnswer(question) {
            const userAnswer = germanInput.value.trim().toLowerCase();
            const rightAnswer = question.correctAnswer.toLowerCase();
            const isCorrect = userAnswer === rightAnswer;

            answered = true;
            germanInput.disabled = true;
            checkBtn.disabled = true;
            nextBtn.disabled = false;

            const item = question.item;
            const noun = question.noun;
            const genderText = noun.article === 'der' ? '阳性' : (noun.article === 'die' ? '阴性' : '中性');

            if (isCorrect) {
                correctAnswers++;
                streak++;
                checkStreakEncouragement();
                germanInput.classList.add('correct');
                feedback.classList.add('show', 'correct');
                feedbackIcon.textContent = '✓';
                feedbackText.textContent = '正确！';
                document.getElementById('correctAnswer').textContent = '';
                retryBtn.classList.add('hidden');

                answerDetails.innerHTML = `
                    <div class="answer-detail-row">
                        <span class="detail-label">完整表达:</span>
                        <span class="detail-value correct-val">${question.correctAnswer} ${noun.noun}</span>
                    </div>
                `;
            } else {
                wrongWords.push(question);
                if (streak > 0) {
                    streak = 0;
                }
                germanInput.classList.add('incorrect');
                feedback.classList.add('show', 'incorrect');
                feedbackIcon.textContent = '✗';
                feedbackText.textContent = '错误';
                document.getElementById('correctAnswer').textContent = `正确答案: ${question.correctAnswer}`;
                retryBtn.classList.remove('hidden');

                answerDetails.innerHTML = `
                    <div class="answer-detail-row">
                        <span class="detail-label">你的答案:</span>
                        <span class="detail-value incorrect-val">${userAnswer || '(空)'}</span>
                    </div>
                    <div class="answer-detail-row">
                        <span class="detail-label">名词性别:</span>
                        <span class="detail-value">${noun.article} (${genderText})</span>
                    </div>
                    <div class="answer-detail-row">
                        <span class="detail-label">规则:</span>
                        <span class="detail-value">${noun.article === 'die' ? '阴性用 ' + item.feminine : '阳性/中性用 ' + item.base}</span>
                    </div>
                `;
            }

            updateStats(isCorrect);
        }

        // Retry Answer
        function retryAnswer() {
            const word = currentWords[currentIndex];

            // Reset answered state
            answered = false;

            // Hide feedback and retry button
            feedback.classList.remove('show', 'correct', 'incorrect', 'partial');
            retryBtn.classList.add('hidden');
            answerDetails.innerHTML = '';
            document.getElementById('correctAnswer').textContent = '';

            // Re-enable check button, disable next button
            checkBtn.disabled = false;
            nextBtn.disabled = true;

            // Handle grammar questions
            if (word.type === 'grammar') {
                germanInput.value = '';
                germanInput.className = 'german-input';
                germanInput.disabled = false;
                germanInput.focus();
                activeInput = germanInput;
            } else {
                const parsed = parseNoun(word.german);

                if (parsed.isNoun) {
                    // Reset article buttons
                    selectedArticle = null;
                    document.querySelectorAll('.article-btn').forEach(btn => {
                        btn.className = 'article-btn';
                        btn.disabled = false;
                    });

                    // Reset and re-enable noun inputs
                    nounInput.value = '';
                    pluralInput.value = '';
                    nounInput.className = 'noun-field-input';
                    pluralInput.className = 'noun-field-input';
                    nounInput.disabled = false;
                    pluralInput.disabled = false;
                    nounInput.focus();
                    activeInput = nounInput;
                } else {
                    // Reset and re-enable regular input
                    germanInput.value = '';
                    germanInput.className = 'german-input';
                    germanInput.disabled = false;
                    germanInput.focus();
                    activeInput = germanInput;
                }
            }

            // Remove from wrong words list if it was added
            const wrongIndex = wrongWords.indexOf(word);
            if (wrongIndex !== -1) {
                wrongWords.splice(wrongIndex, 1);
            }

            updateStats();
        }

        // Check Spelling (for non-noun words)
        function checkSpelling(userAnswer, correctWord) {
            userAnswer = userAnswer.trim();

            // Handle words with optional parts like "dein(e)" accepting "dein" or "deine"
            if (correctWord.includes('(')) {
                const base = correctWord.replace(/\([^)]*\)/g, '');
                const full = correctWord.replace(/[()]/g, '');
                return userAnswer === base || userAnswer === full;
            }

            // Handle words with separable prefixes like "her/kommen" -> "herkommen"
            const normalized = correctWord.replace('/', '');

            // Exact match
            return userAnswer === correctWord || userAnswer === normalized;
        }

        // Next Word
        function nextWord() {
            currentIndex++;
            showCurrentWord();
        }

        // Show Results
        function showResults() {
            practiceCard.classList.add('hidden');
            resultsScreen.classList.add('show');

            const total = currentWords.length;
            const percentage = total > 0 ? Math.round((correctAnswers / total) * 100) : 0;

            document.getElementById('resultsScore').textContent = `${correctAnswers}/${total}`;
            document.getElementById('resultsPercentage').textContent = `正确率: ${percentage}%`;

            // Show special encouragement for perfect score
            if (percentage === 100 && total > 0) {
                setTimeout(() => {
                    showEncouragement('满分！恭喜你！', true);
                }, 500);
            } else if (percentage >= 80) {
                setTimeout(() => {
                    showEncouragement('做得很好！继续努力！');
                }, 500);
            }

            // Wrong words section
            const wrongWordsSection = document.getElementById('wrongWordsSection');
            const wrongWordsList = document.getElementById('wrongWordsList');
            const redoWrongBtn = document.getElementById('redoWrongBtn');

            if (wrongWords.length > 0) {
                wrongWordsSection.classList.remove('hidden');
                redoWrongBtn.classList.remove('hidden');
                wrongWordsList.innerHTML = wrongWords.map(word => {
                    if (word.type === 'grammar') {
                        return `
                            <div class="wrong-word-item">
                                <span class="wrong-german">${word.correctAnswer} ${word.noun.noun}</span>
                                <span class="wrong-chinese">${word.item.chinese} + ${word.noun.chinese}</span>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="wrong-word-item">
                                <span class="wrong-german">${word.german}</span>
                                <span class="wrong-chinese">${word.chinese}</span>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                wrongWordsSection.classList.add('hidden');
                redoWrongBtn.classList.add('hidden');
            }

            // Lesson stats for random mode
            const lessonStatsSection = document.getElementById('lessonStats');
            const lessonStatsList = document.getElementById('lessonStatsList');

            if (currentMode === 'random' && Object.keys(lessonStats).length > 0) {
                lessonStatsSection.classList.remove('hidden');
                lessonStatsList.innerHTML = Object.entries(lessonStats)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([lesson, stats]) => {
                        const pct = Math.round((stats.correct / stats.total) * 100);
                        return `
                            <div class="lesson-stat-item">
                                <span class="lesson-stat-name">${lesson}</span>
                                <div class="lesson-stat-bar">
                                    <div class="lesson-stat-fill" style="width: ${pct}%"></div>
                                </div>
                                <span class="lesson-stat-value">${stats.correct}/${stats.total}</span>
                            </div>
                        `;
                    }).join('');
            } else {
                lessonStatsSection.classList.add('hidden');
            }
        }

        // Redo Wrong Words
        function redoWrongWords() {
            if (wrongWords.length === 0) return;

            currentWords = shuffleArray([...wrongWords]);
            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            lessonStats = {};
            streak = 0;

            resultsScreen.classList.remove('show');
            practiceCard.classList.remove('hidden');

            showCurrentWord();
            updateStats();
            document.getElementById('streakStat').classList.remove('active');
        }

        // Restart Practice
        function restartPractice() {
            startPractice();
        }

        // Reset State
        function resetState() {
            currentWords = [];
            currentIndex = 0;
            correctAnswers = 0;
            wrongWords = [];
            answered = false;
            lessonStats = {};
            streak = 0;
            updateStats();
            updateProgress();
            document.getElementById('streakStat').classList.remove('active');
        }

        // On Lesson Change
        function onLessonChange() {
            if (!welcomeScreen.classList.contains('hidden')) return;
            startPractice();
        }

        // Update Progress Badge
        function updateProgress() {
            const total = currentWords.length;
            const current = Math.min(currentIndex + 1, total);
            progressBadge.textContent = total > 0 ? `${current}/${total}` : '0/0';
        }

        // Update Stats Display
        function updateStats(isCorrectAnswer = null) {
            const total = currentIndex + (answered ? 1 : 0);
            const wrongCount = wrongWords.length;
            const rate = total > 0 ? Math.round((correctAnswers / total) * 100) : 0;

            // Update top stats bar
            document.getElementById('correctCountTop').textContent = correctAnswers;
            document.getElementById('wrongCountTop').textContent = wrongCount;
            document.getElementById('rateValue').textContent = rate + '%';
            document.getElementById('streakValue').textContent = streak;

            // Update old stats (kept for compatibility)
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = total;

            // Animate stats on answer
            if (isCorrectAnswer === true) {
                animateStat('correctStat', 'animate-correct');
                // Activate streak glow if streak > 0
                const streakStat = document.getElementById('streakStat');
                if (streak > 0) {
                    streakStat.classList.add('active');
                }
            } else if (isCorrectAnswer === false) {
                animateStat('wrongStat', 'animate-wrong');
                // Remove streak glow
                document.getElementById('streakStat').classList.remove('active');
            }
        }

        // Animate a stat element
        function animateStat(elementId, animationClass) {
            const element = document.getElementById(elementId);
            element.classList.remove(animationClass);
            // Trigger reflow to restart animation
            void element.offsetWidth;
            element.classList.add(animationClass);

            // Remove animation class after it completes
            setTimeout(() => {
                element.classList.remove(animationClass);
            }, 500);
        }

        // Show encouragement message
        function showEncouragement(message, isPerfect = false) {
            const encouragement = document.getElementById('encouragement');
            encouragement.textContent = message;
            encouragement.classList.remove('perfect');
            if (isPerfect) {
                encouragement.classList.add('perfect');
            }
            encouragement.classList.add('show');

            setTimeout(() => {
                encouragement.classList.remove('show');
            }, 2000);
        }

        // Check and show streak encouragement
        function checkStreakEncouragement() {
            if (streak === 3) {
                showEncouragement('不错！继续保持！');
            } else if (streak === 5) {
                showEncouragement('太棒了！你真厉害！');
            } else if (streak === 10) {
                showEncouragement('完美！你是德语达人！', true);
            } else if (streak === 15) {
                showEncouragement('无敌！无人能挡！', true);
            } else if (streak === 20) {
                showEncouragement('传奇！德语之神！', true);
            }
        }

        // LocalStorage Functions
        function loadProgress() {
            try {
                const data = localStorage.getItem('germanVocabProgress');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }

        function saveProgress(progress) {
            try {
                localStorage.setItem('germanVocabProgress', JSON.stringify(progress));
            } catch (e) {
                console.error('Failed to save progress:', e);
            }
        }

        function updateWordProgress(german, isCorrect) {
            const progress = loadProgress();
            if (!progress[german]) {
                progress[german] = { attempts: 0, correct: 0 };
            }
            progress[german].attempts++;
            if (isCorrect) {
                progress[german].correct++;
            }
            saveProgress(progress);
        }

        function clearStorage() {
            if (confirm('确定要清除所有学习记录吗？')) {
                localStorage.removeItem('germanVocabProgress');
                alert('学习记录已清除');
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
